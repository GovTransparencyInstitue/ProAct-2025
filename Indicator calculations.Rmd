## ---- ProACT Indicator Pipeline ---- ##

data_dir <- "/var/tmp/ivana"   


##Packages###
library(data.table)    
library(dplyr)         
library(stringr)      
library(purrr)         
library(tidyr)
library(readr)         
library(janitor)   


# --------------------------------------------------
# country_data()
# --------------------------------------------------

country_data <- function(country_code, data_dir) {
  file_path <- file.path(data_dir, paste0(country_code, "_export.csv"))
  dt <- fread(
    file_path,
    keepLeadingZeros = TRUE,
    encoding = "UTF-8",
    na.strings = c("", "-", "NA")
  )
  return(dt)
}


# --------------------------------------------------
# 1. Transparency indicators
# --------------------------------------------------
# - Most indicators apply to all awarded contracts.
# - Selected indicators are restricted to competitive procedures
# In all indicators: 1 = value is present in the dataset
# Benford: binary red-flag for aggregation (NOT part of transparency index)
#   ind_tr_benford: 1 = red flag (likely manipulated), 0 = not red flag, NA = unknown

library(data.table)

vars_exist <- function(dt, vars) {
  all(vars %in% names(dt))
}

present01 <- function(x) {
  as.integer(!is.na(x) & trimws(as.character(x)) != "")
}

calc_transparency_indicators <- function(dt) {
  setDT(dt)

  # -------------------------
  # 0) Initialize indicators
  #   - Missing input column => indicator stays 0
  #   - Benford: NA if source missing
  # -------------------------
  dt[, `:=`(
    ind_tr_proc_type       = 0L,
    ind_tr_buyer_id        = 0L,
    ind_tr_supplier_id     = 0L,
    ind_tr_award_pub       = 0L,
    ind_tr_buyer_loc       = 0L,
    ind_tr_supplier_loc    = 0L,
    ind_tr_impl_loc        = 0L,
    ind_tr_contract_value  = 0L,
    ind_tr_call_pub        = 0L,
    ind_tr_bid_deadline    = 0L,
    ind_tr_bid_opening     = 0L,
    ind_tr_prod_code       = 0L,
    ind_tr_benford         = NA_integer_
  )]

  # -------------------------
  # 1) All awarded contracts
  # -------------------------
  if ("tender_proceduretype" %in% names(dt)) {
    dt[, ind_tr_proc_type := present01(tender_proceduretype)]
  }

  if ("buyer_id" %in% names(dt)) {
    dt[, ind_tr_buyer_id := present01(buyer_id)]
  }

  if ("bidder_id" %in% names(dt)) {
    dt[, ind_tr_supplier_id := present01(bidder_id)]
  }

  if ("tender_publications_firstdcontractawarddate" %in% names(dt)) {
    dt[, ind_tr_award_pub := present01(tender_publications_firstdcontractawarddate)]
  }

  # Buyer location: 1 if at least one of (buyer_nuts, buyer_city, buyer_postcode) is present
  buyer_loc_cols <- intersect(c("buyer_nuts", "buyer_city", "buyer_postcode"), names(dt))
  if (length(buyer_loc_cols) > 0) {
    dt[, ind_tr_buyer_loc := as.integer(
      Reduce(`|`, lapply(.SD, function(col) present01(col) == 1L))
    ), .SDcols = buyer_loc_cols]
  }

  if ("bidder_nuts" %in% names(dt)) {
    dt[, ind_tr_supplier_loc := present01(bidder_nuts)]
  }

  if ("tender_addressofimplementation_nuts" %in% names(dt)) {
    dt[, ind_tr_impl_loc := present01(tender_addressofimplementation_nuts)]
  }

  if ("bid_priceusd" %in% names(dt)) {
    dt[, ind_tr_contract_value := present01(bid_priceusd)]
  }

  # -------------------------
  # 2) Competitive procedures only
  # -------------------------
  if ("tender_proceduretype" %in% names(dt)) {

    # Normalize to avoid case/whitespace mismatches
    dt[, proc_clean := toupper(trimws(as.character(tender_proceduretype)))]
    dt[, competitive := !is.na(proc_clean) & proc_clean %in% c("OPEN", "RESTRICTED")]

    if ("tender_publications_firstcallfortenderdate" %in% names(dt)) {
      dt[competitive == TRUE,
         ind_tr_call_pub := present01(tender_publications_firstcallfortenderdate)]
    }

    if ("tender_biddeadline" %in% names(dt)) {
      dt[competitive == TRUE,
         ind_tr_bid_deadline := present01(tender_biddeadline)]
    }

    # NOTE: This uses notice_url as a proxy for bid opening info.
    if ("notice_url" %in% names(dt)) {
      dt[competitive == TRUE,
         ind_tr_bid_opening := present01(notice_url)]
    }

    # Clean up helper columns so they don't leak into exports
    dt[, c("proc_clean", "competitive") := NULL]
  }

  # -------------------------
  # 3) Product code
  # -------------------------
  if ("lot_productcode" %in% names(dt)) {
    dt[, ind_tr_prod_code := as.integer({
      pc <- trimws(as.character(lot_productcode))
      !is.na(pc) & pc != "" & !(pc %in% c("99000000", "99100000", "99200000", "99300000"))
    })]
  }

  # -------------------------
  # 3b) Benford anomaly (NOT part of transparency index)
  # Source: ind_corr_benfords (commonly 0/50/100)
  # Meaning you gave:
  #   100 = less likely manipulated (NOT a red flag)
  #   0   = most likely manipulated (red flag)
  # Binary flag for aggregation:
  #   1 = red flag (likely manipulated)
  #   0 = not red flag
  # -------------------------
  if ("ind_corr_benfords" %in% names(dt)) {
    dt[, ind_tr_benford := fifelse(
      is.na(ind_corr_benfords),
      NA_integer_,
      fifelse(as.integer(ind_corr_benfords) %in% c(0L, 50L), 1L,
              fifelse(as.integer(ind_corr_benfords) == 100L, 0L, NA_integer_))
    )]
  }

  # -------------------------
  # 4) Transparency index (EXCLUDES Benford)
  # -------------------------
  TR_INDICATOR_VARS <- c(
    "ind_tr_proc_type",
    "ind_tr_buyer_id",
    "ind_tr_supplier_id",
    "ind_tr_award_pub",
    "ind_tr_buyer_loc",
    "ind_tr_supplier_loc",
    "ind_tr_impl_loc",
    "ind_tr_contract_value",
    "ind_tr_call_pub",
    "ind_tr_bid_deadline",
    "ind_tr_bid_opening",
    "ind_tr_prod_code"
  )

  dt[, ind_tr_index := rowMeans(.SD), .SDcols = TR_INDICATOR_VARS]

  return(dt)
}


# --------------------------------------------------
# 2. Openness indicators
# --------------------------------------------------

calc_openness_indicators <- function(dt) {
  setDT(dt)

  # ==================================================
  # Openness indicators
  #  1) ind_op_open_proc_method     (0/1) from ind_corr_nonopen_proc_method (0/50/100)
  #  2) ind_op_nonopen_proc_method  (0/1) from ind_corr_nonopen_proc_method (0/50/100)
  #  3) ind_op_subm_period          (continuous days) mirrors submp (competitive only)
  #  4) ind_op_short_subm_period    (0/1) derived from ind_corr_subm_period (0/50/100, competitive only)
  # ==================================================

  # -------------------------
  # 0) Initialize outputs
  # -------------------------
  dt[, `:=`(
    ind_op_open_proc_method    = NA_integer_,
    ind_op_nonopen_proc_method = NA_integer_,
    ind_op_subm_period         = NA_integer_,  # continuous days (submp)
    ind_op_short_subm_period   = NA_integer_   # 0/1 from ind_corr_subm_period
  )]

  # -------------------------
  # 1) Procedure method risk score (0/50/100) -> binary open/non-open
  # Applies to ALL procedures
  # Source: ind_corr_nonopen_proc_method
  # Meaning:
  #   100 = OPEN (not red flag)
  #    50 = LIMITED (mild red flag)
  #     0 = NON-OPEN (red flag)
  # -------------------------
  if ("ind_corr_nonopen_proc_method" %in% names(dt)) {

    dt[, ind_op_open_proc_method := fifelse(
      is.na(ind_corr_nonopen_proc_method),
      NA_integer_,
      as.integer(as.integer(ind_corr_nonopen_proc_method) == 100L)
    )]

    dt[, ind_op_nonopen_proc_method := fifelse(
      is.na(ind_corr_nonopen_proc_method),
      NA_integer_,
      as.integer(as.integer(ind_corr_nonopen_proc_method) %in% c(50L, 0L))
    )]
  }

  # -------------------------
  # 2) Competitive mask (used ONLY for period indicators)
  # Competitive = OPEN or RESTRICTED procedure type
  # -------------------------
  competitive <- rep(NA, nrow(dt))
  if ("tender_proceduretype" %in% names(dt)) {
    proc_clean <- toupper(trimws(as.character(dt[["tender_proceduretype"]])))
    competitive <- !is.na(proc_clean) & proc_clean %in% c("OPEN", "RESTRICTED")
  }

  # -------------------------
  # 3) Submission period (continuous days) mirrors submp, competitive only
  # -------------------------
  if ("submp" %in% names(dt)) {
    dt[competitive == TRUE, ind_op_subm_period := as.integer(submp)]
  }

  # -------------------------
  # 4) Short submission period flag (0/1) from ind_corr_subm_period (0/50/100), competitive only
  #   100 -> 0 (not a red flag)
  #   50 or 0 -> 1 (short / red flag of any level)
  # -------------------------
  if ("ind_corr_subm_period" %in% names(dt)) {
    dt[competitive == TRUE, ind_op_short_subm_period := fifelse(
      is.na(ind_corr_subm_period),
      NA_integer_,
      as.integer(as.integer(ind_corr_subm_period) %in% c(50L, 0L))
    )]
  }

  return(dt)
}

# --------------------------------------------------
# 3. Administrative efficiency indicators
# --------------------------------------------------

  calc_admin_efficiency_indicators <- function(dt) {
  setDT(dt)

  # -------------------------
  # 0) Initialize outputs
  # -------------------------
  dt[, `:=`(
    ind_adm_dec_period     = NA_integer_,  # continuous days (decp)
    ind_adm_long_dec_flag  = NA_integer_   # 0/1 derived from ind_corr_dec_period (0/50/100)
  )]

  # -------------------------
  # 1) Competitive mask (ONLY compute these indicators for competitive)
  # Competitive = OPEN or RESTRICTED procedure type
  # -------------------------
  competitive <- rep(NA, nrow(dt))
  if ("tender_proceduretype" %in% names(dt)) {
    proc_clean <- toupper(trimws(as.character(dt[["tender_proceduretype"]])))
    competitive <- !is.na(proc_clean) & proc_clean %in% c("OPEN", "RESTRICTED")
  }

  # -------------------------
  # 2) Decision period (continuous) mirrors decp, competitive only
  # -------------------------
  if ("decp" %in% names(dt)) {
    dt[competitive == TRUE, ind_adm_dec_period := as.integer(decp)]
  }

  # -------------------------
  # 3) Long decision period flag (binary) from ind_corr_dec_period (0/50/100), competitive only
  #   100 -> 0 (not a red flag)
  #   50 or 0 -> 1 (long decision period red flag of any level)
  # -------------------------
  if ("ind_corr_dec_period" %in% names(dt)) {
    dt[competitive == TRUE, ind_adm_long_dec_flag := fifelse(
      is.na(ind_corr_dec_period),
      NA_integer_,
      as.integer(as.integer(ind_corr_dec_period) %in% c(50L, 0L))
    )]
  }

  return(dt)
}

# --------------------------------------------------
# 4. Competition indicators
# --------------------------------------------------

calc_competition_indicators <- function(dt) {
  setDT(dt)

  # -------------------------
  # 0) Initialize outputs
  # -------------------------
  dt[, `:=`(
    ind_comp_avg_bids            = NA_real_,
    ind_comp_single_bid          = NA_integer_,
    ind_comp_foreign_supplier    = NA_integer_,
    ind_comp_bidder_non_l        = NA_integer_,  # from ind_comp_bidder_non_local (0/100)
    ind_comp_tax_haven_suppliers = NA_integer_
  )]

  # -------------------------
  # Eligibility mask for avg bids + single bidding:
  #   - Only OPEN procedure tenders
  #   - (Removed filter: ind_tr_bids_nr_missing == 0)
  # -------------------------
  eligible_open <- rep(FALSE, nrow(dt))
  if ("tender_proceduretype" %in% names(dt)) {
    proc_clean <- toupper(trimws(as.character(dt[["tender_proceduretype"]])))
    eligible_open <- !is.na(proc_clean) & proc_clean == "OPEN"
  }

  # -------------------------
  # 1) Average number of bids (mirror bids count), OPEN rows only
  # Uses ind_comp_bids_count if present, otherwise bid_number if present
  # -------------------------
  bids_col <- if ("ind_comp_bids_count" %in% names(dt)) {
    "ind_comp_bids_count"
  } else if ("bid_number" %in% names(dt)) {
    "bid_number"
  } else {
    NA_character_
  }

  if (!is.na(bids_col)) {
    dt[eligible_open == TRUE, ind_comp_avg_bids := fifelse(
      is.na(get(bids_col)),
      NA_real_,
      as.numeric(get(bids_col))
    )]
  }

  # -------------------------
  # 2) Single bidding (binary), OPEN rows only
  # Original ind_corr_singleb coding (your definition):
  #   100 = more than 1 bid received
  #     0 = 1 bid received
  # Desired output:
  #   1 = single bid (1 bid received)
  #   0 = not single bid (>1 bid)
  # -------------------------
  if ("ind_corr_singleb" %in% names(dt)) {
    dt[eligible_open == TRUE, ind_comp_single_bid := fifelse(
      is.na(ind_corr_singleb),
      NA_integer_,
      fifelse(ind_corr_singleb == 0L, 1L,
              fifelse(ind_corr_singleb == 100L, 0L, NA_integer_))
    )]
  }

  # -------------------------
  # 3) Foreign supplier (1 = bidder_country != tender_country)
  # -------------------------
  if (all(c("bidder_country", "tender_country") %in% names(dt))) {
    dt[, bidder_country_clean := toupper(trimws(as.character(bidder_country)))]
    dt[, tender_country_clean := toupper(trimws(as.character(tender_country)))]

    dt[, ind_comp_foreign_supplier := fifelse(
      bidder_country_clean == "" | tender_country_clean == "",
      NA_integer_,
      fifelse(
        is.na(bidder_country_clean) | is.na(tender_country_clean),
        NA_integer_,
        as.integer(bidder_country_clean != tender_country_clean)
      )
    )]

    dt[, c("bidder_country_clean", "tender_country_clean") := NULL]
  }

  # -------------------------
  # 4) Non-local supplier (from 0/100 coding)
  # Source: ind_comp_bidder_non_local
  # 100 -> 1, 0 -> 0, NA -> NA, else NA
  # -------------------------
  if ("ind_comp_bidder_non_local" %in% names(dt)) {
    dt[, ind_comp_bidder_non_l := fifelse(
      is.na(ind_comp_bidder_non_local),
      NA_integer_,
      fifelse(ind_comp_bidder_non_local == 100L, 1L,
              fifelse(ind_comp_bidder_non_local == 0L, 0L, NA_integer_))
    )]
  }

  # -------------------------
  # 5) Tax haven supplier flag
  # Base: ind_corr_taxhaven (0 = tax haven, 100 = not tax haven)
  # Output: 1 = tax haven supplier, 0 = not tax haven, NA = unknown
  # -------------------------
  if ("ind_corr_taxhaven" %in% names(dt)) {
    dt[, ind_comp_tax_haven_suppliers := fifelse(
      is.na(ind_corr_taxhaven),
      NA_integer_,
      fifelse(ind_corr_taxhaven == 0L, 1L,
              fifelse(ind_corr_taxhaven == 100L, 0L, NA_integer_))
    )]
  }

  return(dt)
}


# --------------------------------------------------
# 5. Economic performance & value for money
# --------------------------------------------------

#Sector composition: not as separate indicator



# --------------------------------------------------
# COUNTRY LEVEL CALCULATIONS
# --------------------------------------------------

# Transparency index inputs (do NOT include benford here, since it's not part of index)
TR_INDICATOR_VARS <- c(
  "ind_tr_proc_type",
  "ind_tr_buyer_id",
  "ind_tr_supplier_id",
  "ind_tr_award_pub",
  "ind_tr_buyer_loc",
  "ind_tr_supplier_loc",
  "ind_tr_impl_loc",
  "ind_tr_contract_value",
  "ind_tr_call_pub",
  "ind_tr_bid_deadline",
  "ind_tr_bid_opening",
  "ind_tr_prod_code"
)

# All transparency outputs you want tabulated
# (benford is not in index, but you still might want it in tables/exports)
IND_TR_VARS <- c(TR_INDICATOR_VARS, "ind_tr_index", "ind_tr_benford")

# Openness (FINAL names)
IND_OP_VARS <- c(
  "ind_op_open_proc_method",
  "ind_op_nonopen_proc_method",
  "ind_op_subm_period",
  "ind_op_short_subm_period"
)

# Admin efficiency (FINAL names)
IND_ADM_VARS <- c(
  "ind_adm_dec_period",
  "ind_adm_long_dec_flag"
)

# Competition (include the new non-local recode)
IND_COMP_VARS <- c(
  "ind_comp_avg_bids",
  "ind_comp_single_bid",
  "ind_comp_foreign_supplier",
  "ind_comp_bidder_non_l",
  "ind_comp_tax_haven_suppliers"
)


run_country <- function(cc, data_dir) {

  dt <- country_data(country_code = cc, data_dir = data_dir)
  setDT(dt)

  # -------------------------
  # Country-specific filters
  # -------------------------
  # Indonesia: keep only winning bids (awarded contracts)
  if (cc == "ID" && "bid_iswinning" %in% names(dt)) {
    dt <- dt[tolower(trimws(as.character(bid_iswinning))) %in% c("true", "t", "1", "yes", "y")]
  }

  # -------------------------
  # Compute indicator groups
  # -------------------------
  dt <- calc_transparency_indicators(dt)
  dt <- calc_openness_indicators(dt)
  dt <- calc_admin_efficiency_indicators(dt)
  dt <- calc_competition_indicators(dt)

  # Helper: only tabulate vars that exist (prevents errors if a function changes later)
  tabulate_vars <- function(vars, dt) {
    vars_ok <- intersect(vars, names(dt))
    setNames(
      lapply(vars_ok, function(v) table(dt[[v]], useNA = "ifany")),
      vars_ok
    )
  }

  list(
    data = dt,
    tables_tr   = tabulate_vars(IND_TR_VARS, dt),
    tables_op   = tabulate_vars(IND_OP_VARS, dt),
    tables_adm  = tabulate_vars(IND_ADM_VARS, dt),
    tables_comp = tabulate_vars(IND_COMP_VARS, dt)
  )
}


# --------------------------------------------------
# Countries
# --------------------------------------------------

# Armenia
am <- run_country("AM", data_dir)
dt_am <- am$data
tables_tr_am   <- am$tables_tr
tables_op_am   <- am$tables_op
tables_adm_am  <- am$tables_adm
tables_comp_am <- am$tables_comp

# Austria
at <- run_country("AT", data_dir)
dt_at <- at$data
tables_tr_at   <- at$tables_tr
tables_op_at   <- at$tables_op
tables_adm_at  <- at$tables_adm
tables_comp_at <- at$tables_comp

# Belgium
be <- run_country("BE", data_dir)
dt_be <- be$data
tables_tr_be   <- be$tables_tr
tables_op_be   <- be$tables_op
tables_adm_be  <- be$tables_adm
tables_comp_be <- be$tables_comp

# Bulgaria
bg <- run_country("BG", data_dir)
dt_bg <- bg$data
tables_tr_bg   <- bg$tables_tr
tables_op_bg   <- bg$tables_op
tables_adm_bg  <- bg$tables_adm
tables_comp_bg <- bg$tables_comp

# Switzerland
ch <- run_country("CH", data_dir)
dt_ch <- ch$data
tables_tr_ch   <- ch$tables_tr
tables_op_ch   <- ch$tables_op
tables_adm_ch  <- ch$tables_adm
tables_comp_ch <- ch$tables_comp

# Chile
cl <- run_country("CL", data_dir)
dt_cl <- cl$data
tables_tr_cl   <- cl$tables_tr
tables_op_cl   <- cl$tables_op
tables_adm_cl  <- cl$tables_adm
tables_comp_cl <- cl$tables_comp

# Colombia
co <- run_country("CO", data_dir)
dt_co <- co$data
tables_tr_co   <- co$tables_tr
tables_op_co   <- co$tables_op
tables_adm_co  <- co$tables_adm
tables_comp_co <- co$tables_comp

# Cyprus
cy <- run_country("CY", data_dir)
dt_cy <- cy$data
tables_tr_cy   <- cy$tables_tr
tables_op_cy   <- cy$tables_op
tables_adm_cy  <- cy$tables_adm
tables_comp_cy <- cy$tables_comp

# Czech Republic
cz <- run_country("CZ", data_dir)
dt_cz <- cz$data
tables_tr_cz   <- cz$tables_tr
tables_op_cz   <- cz$tables_op
tables_adm_cz  <- cz$tables_adm
tables_comp_cz <- cz$tables_comp

# Germany
de <- run_country("DE", data_dir)
dt_de <- de$data
tables_tr_de   <- de$tables_tr
tables_op_de   <- de$tables_op
tables_adm_de  <- de$tables_adm
tables_comp_de <- de$tables_comp

# Denmark
dk <- run_country("DK", data_dir)
dt_dk <- dk$data
tables_tr_dk   <- dk$tables_tr
tables_op_dk   <- dk$tables_op
tables_adm_dk  <- dk$tables_adm
tables_comp_dk <- dk$tables_comp

# Estonia
ee <- run_country("EE", data_dir)
dt_ee <- ee$data
tables_tr_ee   <- ee$tables_tr
tables_op_ee   <- ee$tables_op
tables_adm_ee  <- ee$tables_adm
tables_comp_ee <- ee$tables_comp

# Spain
es <- run_country("ES", data_dir)
dt_es <- es$data
tables_tr_es   <- es$tables_tr
tables_op_es   <- es$tables_op
tables_adm_es  <- es$tables_adm
tables_comp_es <- es$tables_comp

# Finland
fi <- run_country("FI", data_dir)
dt_fi <- fi$data
tables_tr_fi   <- fi$tables_tr
tables_op_fi   <- fi$tables_op
tables_adm_fi  <- fi$tables_adm
tables_comp_fi <- fi$tables_comp

# France
fr <- run_country("FR", data_dir)
dt_fr <- fr$data
tables_tr_fr   <- fr$tables_tr
tables_op_fr   <- fr$tables_op
tables_adm_fr  <- fr$tables_adm
tables_comp_fr <- fr$tables_comp

# Georgia
ge <- run_country("GE", data_dir)
dt_ge <- ge$data
tables_tr_ge   <- ge$tables_tr
tables_op_ge   <- ge$tables_op
tables_adm_ge  <- ge$tables_adm
tables_comp_ge <- ge$tables_comp

# Greece
gr <- run_country("GR", data_dir)
dt_gr <- gr$data
tables_tr_gr   <- gr$tables_tr
tables_op_gr   <- gr$tables_op
tables_adm_gr  <- gr$tables_adm
tables_comp_gr <- gr$tables_comp

# Croatia
hr <- run_country("HR", data_dir)
dt_hr <- hr$data
tables_tr_hr   <- hr$tables_tr
tables_op_hr   <- hr$tables_op
tables_adm_hr  <- hr$tables_adm
tables_comp_hr <- hr$tables_comp

# Hungary
hu <- run_country("HU", data_dir)
dt_hu <- hu$data
tables_tr_hu   <- hu$tables_tr
tables_op_hu   <- hu$tables_op
tables_adm_hu  <- hu$tables_adm
tables_comp_hu <- hu$tables_comp

# Indonesia
id <- run_country("ID", data_dir)
dt_id <- id$data
tables_tr_id   <- id$tables_tr
tables_op_id   <- id$tables_op
tables_adm_id  <- id$tables_adm
tables_comp_id <- id$tables_comp

# Ireland
ie <- run_country("IE", data_dir)
dt_ie <- ie$data
tables_tr_ie   <- ie$tables_tr
tables_op_ie   <- ie$tables_op
tables_adm_ie  <- ie$tables_adm
tables_comp_ie <- ie$tables_comp

# India
in_ <- run_country("IN", data_dir)
dt_in <- in_$data
tables_tr_in   <- in_$tables_tr
tables_op_in   <- in_$tables_op
tables_adm_in  <- in_$tables_adm
tables_comp_in <- in_$tables_comp

# Iceland
is_ <- run_country("IS", data_dir)
dt_is <- is_$data
tables_tr_is   <- is_$tables_tr
tables_op_is   <- is_$tables_op
tables_adm_is  <- is_$tables_adm
tables_comp_is <- is_$tables_comp

# Italy
it <- run_country("IT", data_dir)
dt_it <- it$data
tables_tr_it   <- it$tables_tr
tables_op_it   <- it$tables_op
tables_adm_it  <- it$tables_adm
tables_comp_it <- it$tables_comp

# Jamaica
jm <- run_country("JM", data_dir)
dt_jm <- jm$data
tables_tr_jm   <- jm$tables_tr
tables_op_jm   <- jm$tables_op
tables_adm_jm  <- jm$tables_adm
tables_comp_jm <- jm$tables_comp

# Kenya
ke <- run_country("KE", data_dir)
dt_ke <- ke$data
tables_tr_ke   <- ke$tables_tr
tables_op_ke   <- ke$tables_op
tables_adm_ke  <- ke$tables_adm
tables_comp_ke <- ke$tables_comp

# Lithuania
lt <- run_country("LT", data_dir)
dt_lt <- lt$data
tables_tr_lt   <- lt$tables_tr
tables_op_lt   <- lt$tables_op
tables_adm_lt  <- lt$tables_adm
tables_comp_lt <- lt$tables_comp

# Luxembourg
lu <- run_country("LU", data_dir)
dt_lu <- lu$data
tables_tr_lu   <- lu$tables_tr
tables_op_lu   <- lu$tables_op
tables_adm_lu  <- lu$tables_adm
tables_comp_lu <- lu$tables_comp

# Latvia
lv <- run_country("LV", data_dir)
dt_lv <- lv$data
tables_tr_lv   <- lv$tables_tr
tables_op_lv   <- lv$tables_op
tables_adm_lv  <- lv$tables_adm
tables_comp_lv <- lv$tables_comp

# Moldova
md <- run_country("MD", data_dir)
dt_md <- md$data
tables_tr_md   <- md$tables_tr
tables_op_md   <- md$tables_op
tables_adm_md  <- md$tables_adm
tables_comp_md <- md$tables_comp

# North Macedonia
mk <- run_country("MK", data_dir)
dt_mk <- mk$data
tables_tr_mk   <- mk$tables_tr
tables_op_mk   <- mk$tables_op
tables_adm_mk  <- mk$tables_adm
tables_comp_mk <- mk$tables_comp

# Malta
mt <- run_country("MT", data_dir)
dt_mt <- mt$data
tables_tr_mt   <- mt$tables_tr
tables_op_mt   <- mt$tables_op
tables_adm_mt  <- mt$tables_adm
tables_comp_mt <- mt$tables_comp

# Mexico
mx <- run_country("MX", data_dir)
dt_mx <- mx$data
tables_tr_mx   <- mx$tables_tr
tables_op_mx   <- mx$tables_op
tables_adm_mx  <- mx$tables_adm
tables_comp_mx <- mx$tables_comp

# Netherlands
nl <- run_country("NL", data_dir)
dt_nl <- nl$data
tables_tr_nl   <- nl$tables_tr
tables_op_nl   <- nl$tables_op
tables_adm_nl  <- nl$tables_adm
tables_comp_nl <- nl$tables_comp

# Norway
no <- run_country("NO", data_dir)
dt_no <- no$data
tables_tr_no   <- no$tables_tr
tables_op_no   <- no$tables_op
tables_adm_no  <- no$tables_adm
tables_comp_no <- no$tables_comp

# Poland
pl <- run_country("PL", data_dir)
dt_pl <- pl$data
tables_tr_pl   <- pl$tables_tr
tables_op_pl   <- pl$tables_op
tables_adm_pl  <- pl$tables_adm
tables_comp_pl <- pl$tables_comp

# Portugal
pt <- run_country("PT", data_dir)
dt_pt <- pt$data
tables_tr_pt   <- pt$tables_tr
tables_op_pt   <- pt$tables_op
tables_adm_pt  <- pt$tables_adm
tables_comp_pt <- pt$tables_comp

# Paraguay
py <- run_country("PY", data_dir)
dt_py <- py$data
tables_tr_py   <- py$tables_tr
tables_op_py   <- py$tables_op
tables_adm_py  <- py$tables_adm
tables_comp_py <- py$tables_comp

# Romania
ro <- run_country("RO", data_dir)
dt_ro <- ro$data
tables_tr_ro   <- ro$tables_tr
tables_op_ro   <- ro$tables_op
tables_adm_ro  <- ro$tables_adm
tables_comp_ro <- ro$tables_comp

# Sweden
se <- run_country("SE", data_dir)
dt_se <- se$data
tables_tr_se   <- se$tables_tr
tables_op_se   <- se$tables_op
tables_adm_se  <- se$tables_adm
tables_comp_se <- se$tables_comp

# Slovenia
si <- run_country("SI", data_dir)
dt_si <- si$data
tables_tr_si   <- si$tables_tr
tables_op_si   <- si$tables_op
tables_adm_si  <- si$tables_adm
tables_comp_si <- si$tables_comp

# Slovakia
sk <- run_country("SK", data_dir)
dt_sk <- sk$data
tables_tr_sk   <- sk$tables_tr
tables_op_sk   <- sk$tables_op
tables_adm_sk  <- sk$tables_adm
tables_comp_sk <- sk$tables_comp

# Uganda
ug <- run_country("UG", data_dir)
dt_ug <- ug$data
tables_tr_ug   <- ug$tables_tr
tables_op_ug   <- ug$tables_op
tables_adm_ug  <- ug$tables_adm
tables_comp_ug <- ug$tables_comp

# United Kingdom
uk <- run_country("UK", data_dir)
dt_uk <- uk$data
tables_tr_uk   <- uk$tables_tr
tables_op_uk   <- uk$tables_op
tables_adm_uk  <- uk$tables_adm
tables_comp_uk <- uk$tables_comp

# United States
us <- run_country("US", data_dir)
dt_us <- us$data
tables_tr_us   <- us$tables_tr
tables_op_us   <- us$tables_op
tables_adm_us  <- us$tables_adm
tables_comp_us <- us$tables_comp

# Uruguay
uy <- run_country("UY", data_dir)
dt_uy <- uy$data
tables_tr_uy   <- uy$tables_tr
tables_op_uy   <- uy$tables_op
tables_adm_uy  <- uy$tables_adm
tables_comp_uy <- uy$tables_comp

# --------------------------------------------------
# Export
# --------------------------------------------------

export_dir <- "/var/tmp/ivana/Export 2"
dir.create(export_dir, recursive = TRUE, showWarnings = FALSE)


country_codes <- c(
  "AM","AT","BE","BG","CH","CL","CO","CY","CZ","DE","DK","EE","ES","FI","FR",
  "GE","GR","HR","HU","ID","IE","IN","IS","IT","JM","KE","LT","LU","LV","MD",
  "MK","MT","MX","NL","NO","PL","PT","PY","RO","SE","SI","SK","UG","UK","US","UY"
)


for (cc in country_codes) {
  
  message("Exporting country: ", cc)
  
  res <- run_country(cc, data_dir)
  dt  <- res$data
  
  out_file <- file.path(export_dir, paste0(cc, "_export.csv"))
  
  fwrite(dt, out_file)
}








